<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Hotspots - Sistema de Tours Virtuais 360¬∞</title>
    <!-- Supabase CDN (carregado cedo para garantir window.supabase) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            /* Permitir rolagem vertical para acessar bot√µes no painel direito */
            overflow: auto !important;
            overflow-y: auto !important;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: 100vh;
        }

        .viewer-section {
            position: relative;
            background: #000;
        }

        #panorama {
            width: 100%;
            height: 100%;
        }

        .viewer-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .overlay-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .overlay-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .overlay-btn.active {
            background: #007bff;
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            pointer-events: none;
            z-index: 999;
            display: none;
        }

        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: #ff0000;
        }

        .crosshair::before {
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            transform: translateY(-50%);
        }

        .crosshair::after {
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            transform: translateX(-50%);
        }

        .editor-panel {
            background: white;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #dee2e6;
            /* Garantir rolagem pr√≥pria do painel em telas menores */
            max-height: 100vh;
            overflow-y: auto;
        }

        .panel-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .panel-header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .panel-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-section {
            margin-bottom: 30px;
        }

        .panel-section h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .scene-selector {
            margin-bottom: 20px;
        }

        .scene-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .scene-selector select:focus {
            outline: none;
            border-color: #007bff;
        }

        .hotspot-types {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .hotspot-type {
            padding: 15px 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .hotspot-type:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .hotspot-type.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .hotspot-type-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .hotspot-type-name {
            font-size: 12px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .coordinates-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .coordinate-input {
            text-align: center;
            font-weight: 600;
            background: #f8f9fa !important;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .hotspots-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .hotspot-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 8px;
            background: white;
            transition: all 0.3s ease;
        }

        .hotspot-item:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .hotspot-item.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .hotspot-icon {
            font-size: 16px;
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .hotspot-info {
            flex: 1;
        }

        .hotspot-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .hotspot-coords {
            font-size: 11px;
            opacity: 0.7;
        }

        .hotspot-actions {
            display: flex;
            gap: 5px;
        }

        .hotspot-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .panel-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            /* Fixa o rodap√© ao final do painel para acesso f√°cil */
            position: sticky;
            bottom: 0;
            z-index: 5;
        }

        .alert {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.5;
        }

        .instructions h4 {
            margin-bottom: 10px;
            color: #0056b3;
        }

        .instructions ul {
            margin-left: 15px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        @media (max-width: 1024px) {
            .editor-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60vh 1fr;
            }

            .editor-panel {
                border-left: none;
                border-top: 1px solid #dee2e6;
            }

            .hotspot-types {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Estilos personalizados para hotspots no viewer */
        .pnlm-hotspot-base.hotspot-info {
            background: #007bff !important;
            border: 3px solid white !important;
            border-radius: 50% !important;
            width: 20px !important;
            height: 20px !important;
            cursor: grab !important;
        }

        .pnlm-hotspot-base.hotspot-info:hover {
            background: #0056b3 !important;
            transform: scale(1.2) !important;
            cursor: grabbing !important;
        }

        .pnlm-hotspot-base.hotspot-navigation {
            background: #28a745 !important;
            border: 3px solid white !important;
            border-radius: 10% !important;
            width: 24px !important;
            height: 24px !important;
            cursor: grab !important;
        }

        .pnlm-hotspot-base.hotspot-navigation:hover {
            background: #218838 !important;
            transform: scale(1.2) !important;
            cursor: grabbing !important;
        }



        /* Anima√ß√£o de pulse para hotspots */
        .pnlm-hotspot-base {
            animation: hotspot-pulse 2s infinite;
        }

        @keyframes hotspot-pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }

        .pnlm-hotspot-base.hotspot-navigation {
            animation: hotspot-pulse-green 2s infinite;
        }

        @keyframes hotspot-pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }



        @media (max-width: 768px) {
            .editor-container {
                grid-template-rows: 50vh 1fr;
            }

            .panel-content {
                padding: 15px;
            }

            .hotspot-types {
                grid-template-columns: 1fr;
            }

            .coordinates-display {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Visualizador 360¬∞ -->
        <div class="viewer-section">
            <div id="panorama"></div>

            <div class="viewer-overlay">
                <button class="overlay-btn" id="addModeBtn" onclick="toggleAddMode()">
                    üìç Adicionar Hotspot
                </button>
                <button class="overlay-btn" onclick="goBack()">
                    ‚Üê Voltar
                </button>
                <button class="overlay-btn" onclick="saveAndPreview()">
                    üëÅÔ∏è Preview
                </button>
            </div>

            <div class="crosshair" id="crosshair"></div>
        </div>

        <!-- Painel de Edi√ß√£o -->
        <div class="editor-panel">
            <div class="panel-header">
                <h1>üìç Editor de Hotspots</h1>
                <p>Posicione pontos de interesse nas suas cenas 360¬∞</p>
            </div>

            <div class="panel-content">
                <div id="alert" class="alert"></div>

                <!-- Instru√ß√µes -->
                <div class="instructions">
                    <h4>Como usar:</h4>
                    <ul>
                        <li>Selecione uma cena abaixo</li>
                        <li>Escolha o tipo de hotspot</li>
                        <li>Clique em "Adicionar Hotspot"</li>
                        <li>Clique na imagem 360¬∞ onde deseja posicionar</li>
                        <li>Preencha as informa√ß√µes do hotspot</li>
                    </ul>
                </div>

                <!-- Seletor de Cena -->
                <div class="panel-section">
                    <h3>üé¨ Selecionar Cena</h3>
                    <div class="scene-selector">
                        <select id="sceneSelect" onchange="changeScene()">
                            <option value="">Carregando cenas...</option>
                        </select>
                    </div>
                </div>

                <!-- Tipos de Hotspot -->
                <div class="panel-section">
                    <h3>üéØ Tipo de Hotspot</h3>
                    <div class="hotspot-types">
                        <div class="hotspot-type selected" data-type="info">
                            <div class="hotspot-type-icon">‚ÑπÔ∏è</div>
                            <div class="hotspot-type-name">Informa√ß√£o</div>
                        </div>
                        <div class="hotspot-type" data-type="navigation">
                            <div class="hotspot-type-icon">üö™</div>
                            <div class="hotspot-type-name">Navega√ß√£o</div>
                        </div>
                    </div>
                </div>

                <!-- Formul√°rio do Hotspot -->
                <div class="panel-section">
                    <h3>‚úèÔ∏è Configurar Hotspot</h3>

                    <div class="coordinates-display">
                        <div class="form-group">
                            <label>Pitch (Vertical)</label>
                            <input type="number" id="hotspotPitch" class="coordinate-input"
                                   step="0.1" min="-90" max="90" readonly>
                        </div>
                        <div class="form-group">
                            <label>Yaw (Horizontal)</label>
                            <input type="number" id="hotspotYaw" class="coordinate-input"
                                   step="0.1" min="0" max="360" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="hotspotTitle">T√≠tulo</label>
                        <input type="text" id="hotspotTitle" placeholder="Ex: Sala de Estar">
                    </div>

                    <div class="form-group">
                        <label for="hotspotDescription">Descri√ß√£o</label>
                        <textarea id="hotspotDescription"
                                  placeholder="Descreva este ponto de interesse..."></textarea>
                    </div>

                    <div class="form-group" id="targetSceneGroup" style="display: none;">
                        <label for="targetScene">Cena de Destino</label>
                        <select id="targetScene">
                            <option value="">Selecione uma cena</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="hotspotColor">Cor do Hotspot</label>
                        <input type="color" id="hotspotColor" value="#007bff">
                    </div>

                    <button class="btn btn-primary" id="saveHotspotBtn" onclick="saveHotspot()" disabled>
                        üíæ Salvar Hotspot
                    </button>

                    <button class="btn btn-secondary" id="cancelHotspotBtn" onclick="cancelHotspot()" style="display: none;">
                        ‚ùå Cancelar
                    </button>
                </div>

                <!-- Lista de Hotspots -->
                <div class="panel-section">
                    <h3>üìã Hotspots da Cena</h3>
                    <div class="hotspots-list" id="hotspotsList">
                        <p style="text-align: center; color: #6c757d; padding: 20px;">
                            Selecione uma cena para ver os hotspots
                        </p>
                    </div>
                </div>
            </div>

            <div class="panel-footer">
                <button class="btn btn-success" onclick="saveAndExit()">
                    ‚úÖ Salvar e Finalizar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Inicializa Supabase pelo m√≥dulo compartilhado (garante createClient sem depender do timing do UMD)
        const { authManager, propertyManager, sceneManager, hotspotManager, utils } = await import('/shared/supabase-client.js');
        import '/admin/auth-guard-fixed.js';

        // Normaliza URLs de imagem para evitar localhost/mixed content no Vercel
        function resolveImageUrl(input) {
            try {
                if (!input) return input;
                const u = new URL(input, window.location.origin);
                if (u.hostname === 'localhost' || u.hostname === '127.0.0.1') {
                    return 'https://pannellum.org/images/alma.jpg';
                }
                if (u.origin === window.location.origin && u.pathname.startsWith('/file-')) {
                    return 'https://pannellum.org/images/alma.jpg';
                }
                return u.href;
            } catch (e) {
                if (typeof input === 'string') {
                    if (/^\d+x\d+\?text=/.test(input)) return 'https://via.placeholder.com/' + input;
                    if (input.startsWith('./')) return input.slice(1);
                    if (!input.startsWith('/')) return '/' + input;
                }
                return input;
            }
        }

        let currentUser = null;
        let propertyId = null;
        let currentProperty = null;
        let scenes = [];
        let currentScene = null;
        let hotspots = [];
        let viewer = null;
        let isAddMode = false;
        let selectedHotspotType = 'info';
        let editingHotspot = null;
        let isDragging = false;
        let draggedHotspot = null;
        let dragStartCoords = null;

        // Expor vari√°veis no escopo global para debug
        window.scenes = scenes;
        window.currentScene = currentScene;
        window.viewer = viewer;
        window.isAddMode = isAddMode;

        // Verificar autentica√ß√£o
        authManager.onAuthChange((event, session) => {
            const testLogin = localStorage.getItem('test_admin_logged_in') === 'true';
            if (!session && testLogin) {
                currentUser = { email: localStorage.getItem('test_admin_email') || 'admin@tours360.com' };
                initHotspotEditor();
                return;
            }
            if (!session) {
                window.location.href = 'login-fixed.html';
                return;
            }

            currentUser = session.user;
            initHotspotEditor();
        });

        // Inicializar editor de hotspots
        async function initHotspotEditor() {
            // Obter ID da propriedade da URL
            const urlParams = new URLSearchParams(window.location.search);
            propertyId = urlParams.get('propertyId');

            if (!propertyId) {
                showAlert('ID da propriedade n√£o encontrado.', 'error');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            // Carregar dados (garantir listeners mesmo com falhas)
            try { await loadProperty(); } catch (e) { console.error('Erro ao carregar propriedade:', e); }
            try { await loadScenes(); } catch (e) { console.error('Erro ao carregar cenas:', e); }
            setupEventListeners();
        }

        // Carregar propriedade
        async function loadProperty() {
            try {
                const result = await propertyManager.getProperty(propertyId);

                if (result.success) {
                    currentProperty = result.data;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Erro ao carregar propriedade:', error);
                showAlert('Erro ao carregar propriedade.', 'error');
            }
        }

        // Carregar cenas
        async function loadScenes() {
            try {
                const result = await sceneManager.getScenes(propertyId);

                if (result.success) {
                    scenes = result.data || [];
                    window.scenes = scenes; // Atualizar vari√°vel global
                    populateSceneSelector();

                    if (scenes.length > 0) {
                        // Selecionar primeira cena ou cena padr√£o
                        const defaultScene = scenes.find(s => s.is_default) || scenes[0];
                        document.getElementById('sceneSelect').value = defaultScene.id;
                        await changeScene();
                    } else {
                        showAlert('Nenhuma cena encontrada. Adicione imagens 360¬∞ primeiro.', 'warning');
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Erro ao carregar cenas:', error);
                showAlert('Erro ao carregar cenas.', 'error');
            }
        }

        // Popular seletor de cenas
        function populateSceneSelector() {
            const sceneSelect = document.getElementById('sceneSelect');
            const targetScene = document.getElementById('targetScene');

            sceneSelect.innerHTML = scenes.map(scene =>
                `<option value="${scene.id}">${scene.title}</option>`
            ).join('');

            targetScene.innerHTML = '<option value="">Selecione uma cena</option>' +
                scenes.map(scene =>
                    `<option value="${scene.id}">${scene.title}</option>`
                ).join('');
        }

        // Mudar cena
        window.changeScene = async function() {
            const sceneId = document.getElementById('sceneSelect').value;
            if (!sceneId) return;

                console.log('[HS] changeScene(): sceneId=', sceneId, 'scenes=', scenes?.length);


            currentScene = scenes.find(s => s.id === sceneId);
            window.currentScene = currentScene; // Atualizar vari√°vel global
            if (!currentScene) return;


                console.log('[HS] changeScene(): currentScene=', currentScene?.title || currentScene?.id);

            // Carregar cena no viewer
            loadSceneInViewer();

            // Carregar hotspots da cena
            await loadHotspots();
        };

        // Carregar cena no viewer
        function loadSceneInViewer() {
            if (viewer) {
                viewer.destroy();
            }

            const config = {
                type: 'equirectangular',
                panorama: resolveImageUrl(currentScene.image_url),
                autoLoad: true,
                pitch: currentScene.initial_pitch || 0,
                yaw: currentScene.initial_yaw || 0,
                hfov: currentScene.initial_hfov || 110,
                showControls: true,
                hotSpots: [] // Ser√° populado depois
            };

            viewer = pannellum.viewer('panorama', config);
            window.viewer = viewer; // Atualizar vari√°vel global

            viewer.on('load', () => {
                console.log('Cena carregada:', currentScene.title);
                updateHotspotsInViewer();
            });

            // Adicionar event listener para cliques (modo adicionar) usando evento DOM para obter MouseEvent real
            // Vincula no container interno do Pannellum (preferencial) para garantir o MouseEvent correto
            const panoInner = document.querySelector('#panorama .pnlm-container');
            const panoEl = panoInner || document.getElementById('panorama');
            // Usa capture=true para interceptar antes do Pannellum consumir o evento
            panoEl.addEventListener('mousedown', handleViewerClick, true);
            panoEl.addEventListener('mouseup', handleViewerClick, true);

            // Listener interno do Pannellum (backup)
            viewer.on('mousedown', handleViewerClick);
            viewer.on('mouseup', handleViewerClick);

            // Event listener para movimento do mouse (drag)
            viewer.on('mousemove', handleViewerMouseMove);

                console.log('[HS] loadSceneInViewer(): listeners bound', {
                    hasInner: !!document.querySelector('#panorama .pnlm-container'),
                    hasMouseEventToCoords: typeof viewer?.mouseEventToCoords === 'function'
                });

        }

        // Expor fun√ß√£o no escopo global para debug
        window.loadSceneInViewer = loadSceneInViewer;

        // Carregar hotspots da cena
        async function loadHotspots() {
            if (!currentScene) return;

            try {
                const result = await hotspotManager.getHotspots(currentScene.id);

                if (result.success) {
                    hotspots = result.data || [];
                    updateHotspotsList();
                    updateHotspotsInViewer();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Erro ao carregar hotspots:', error);
                showAlert('Erro ao carregar hotspots.', 'error');
            }
        }

        // Atualizar hotspots no viewer
        function updateHotspotsInViewer() {
            if (!viewer || !hotspots) return;

            try {
                // Remover hotspots existentes (m√©todo correto do Pannellum)
                // Como n√£o h√° removeAllHotSpots, vamos recriar o viewer com hotspots
                // ou usar removeHotSpot para cada um individualmente

                // Adicionar hotspots
                hotspots.forEach(hotspot => {
                    try {
                        const hotspotConfig = {
                            id: hotspot.id,
                            pitch: parseFloat(hotspot.pitch) || 0,
                            yaw: parseFloat(hotspot.yaw) || 0,
                            type: 'info',
                            text: hotspot.title || 'Hotspot',
                            cssClass: `hotspot-${hotspot.type}`,
                            clickHandlerFunc: () => selectHotspot(hotspot.id),
                            createTooltipFunc: (hotSpotDiv, args) => {
                                hotSpotDiv.style.backgroundColor = hotspot.color || '#007bff';
                                hotSpotDiv.style.border = '2px solid white';
                                hotSpotDiv.style.borderRadius = '50%';
                                hotSpotDiv.style.width = '20px';
                                hotSpotDiv.style.height = '20px';
                                hotSpotDiv.style.cursor = 'pointer';
                                return hotspot.title || 'Hotspot';
                            }
                        };

                        viewer.addHotSpot(hotspotConfig);
                        console.log(`‚úÖ Hotspot adicionado: ${hotspot.title} (${hotspot.pitch}, ${hotspot.yaw})`);
                    } catch (error) {
                        console.error(`‚ùå Erro ao adicionar hotspot ${hotspot.id}:`, error);
                    }
                });
            } catch (error) {
                console.error('‚ùå Erro ao atualizar hotspots:', error);
            }
        }

        // Atualizar lista de hotspots
        function updateHotspotsList() {
            const container = document.getElementById('hotspotsList');

            if (hotspots.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: #6c757d; padding: 20px;">
                        Nenhum hotspot nesta cena
                    </p>
                `;
                return;
            }

            container.innerHTML = hotspots.map(hotspot => `
                <div class="hotspot-item" data-hotspot-id="${hotspot.id}">
                    <div class="hotspot-icon">${getHotspotIcon(hotspot.type)}</div>
                    <div class="hotspot-info">
                        <div class="hotspot-title">${hotspot.title}</div>
                        <div class="hotspot-coords">
                            ${hotspot.pitch.toFixed(1)}¬∞, ${hotspot.yaw.toFixed(1)}¬∞
                        </div>
                    </div>
                    <div class="hotspot-actions">
                        <button class="btn-edit" onclick="editHotspot('${hotspot.id}')">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="deleteHotspot('${hotspot.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Obter √≠cone do tipo de hotspot
        function getHotspotIcon(type) {
            const icons = {
                info: '‚ÑπÔ∏è',
                navigation: 'üö™'
            };
            return icons[type] || '‚ÑπÔ∏è';
        }

        // Atualiza a habilitao do bot e3o Salvar conforme os campos obrigat f3rios
        function updateSaveButtonState() {
            const title = (document.getElementById('hotspotTitle')?.value || '').trim();
            const pitch = parseFloat(document.getElementById('hotspotPitch')?.value || '');
            const yaw = parseFloat(document.getElementById('hotspotYaw')?.value || '');
            const hasCoords = !isNaN(pitch) && !isNaN(yaw);
            let ok = hasCoords && title.length > 0;

            console.log('[HS] updateSaveButtonState input', { titleLen: title.length, pitch, yaw, selectedHotspotType, targetScene: document.getElementById('targetScene')?.value });

            if (selectedHotspotType === 'navigation') {
                ok = ok && !!(document.getElementById('targetScene')?.value);
            }
            const btn = document.getElementById('saveHotspotBtn');
            if (btn) btn.disabled = !ok;

            console.log('[HS] saveHotspotBtn.disabled =', btn?.disabled);

        }

        // Configurar event listeners
        function setupEventListeners() {

            console.log('[HS] setupEventListeners(): binding form/type listeners');

            // Tipos de hotspot
            document.querySelectorAll('.hotspot-type').forEach(type => {
                type.addEventListener('click', () => {
                    document.querySelectorAll('.hotspot-type').forEach(t => t.classList.remove('selected'));
                    type.classList.add('selected');
                    selectedHotspotType = type.dataset.type;

                    // Mostrar/ocultar campo de cena de destino
                    const targetSceneGroup = document.getElementById('targetSceneGroup');
                    targetSceneGroup.style.display = selectedHotspotType === 'navigation' ? 'block' : 'none';

                    console.log('[HS] hotspot-type click', { selectedHotspotType });
                    updateSaveButtonState();
                });
            });

            // Inputs que influenciam a valida E7 e3o
            ['hotspotTitle','hotspotDescription','hotspotPitch','hotspotYaw','hotspotColor','targetScene']
                .forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('input', updateSaveButtonState);
                });

            updateSaveButtonState();
        }

        // Toggle modo adicionar
        window.toggleAddMode = function(keepCoordinates = false) {
            isAddMode = !isAddMode;
            window.isAddMode = isAddMode; // Atualizar vari√°vel global

            console.log('[HS] toggleAddMode()', { isAddMode, selectedHotspotType, keepCoordinates });

            const btn = document.getElementById('addModeBtn');
            const crosshair = document.getElementById('crosshair');

            if (isAddMode) {
                btn.classList.add('active');
                btn.textContent = '‚ùå Cancelar Adi√ß√£o';
                crosshair.style.display = 'block';
                showAlert('Clique na imagem 360¬∞ para posicionar o hotspot', 'info');
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üìç Adicionar Hotspot';
                crosshair.style.display = 'none';

                // S√≥ limpar o formul√°rio se n√£o for para manter as coordenadas
                if (!keepCoordinates) {
                    clearHotspotForm();
                } else {
                    showAlert('Coordenadas definidas! Preencha as informa√ß√µes do hotspot.', 'success');
                }
            }
        };

        // Handle clique no viewer
        function handleViewerClick(event) {

            console.log('[HS] handleViewerClick start', {
                type: event?.type,
                isAddMode,
                targetTag: event?.target?.tagName,
                targetClasses: event?.target?.className
            });

            // Verificar se clicou em um hotspot existente
            const clickedElement = event.target;
            const hotspotElement = clickedElement.closest('.pnlm-hotspot-base');

            if (hotspotElement && !isAddMode) {
                // Iniciar drag de hotspot existente
                const hotspotId = hotspotElement.id.replace('pnlm-hotspot-', '');
                const hotspot = hotspots.find(h => h.id === hotspotId);

                if (hotspot) {
                    startDragHotspot(hotspot, event);
                    return;
                }
            }

            if (!isAddMode) { console.log('[HS] handleViewerClick: ignored (isAddMode=false)'); return; }

            // Calcular coordenadas no local clicado (Pannellum retorna graus)
            let pitchDeg, yawDeg;
            if (viewer && typeof viewer.mouseEventToCoords === 'function') {
                const coords = viewer.mouseEventToCoords(event);
                if (Array.isArray(coords)) {
                    pitchDeg = coords[0];
                    yawDeg = ((coords[1] % 360) + 360) % 360;
                }
            }
            if (pitchDeg === undefined || yawDeg === undefined) {
                // Fallback: usa o centro da vis√£o
                pitchDeg = viewer.getPitch();
                yawDeg = ((viewer.getYaw() % 360) + 360) % 360;
            }

            // Preencher coordenadas

            console.log('[HS] handleViewerClick coords', { pitchDeg, yawDeg, hasMouseEventToCoords: typeof viewer?.mouseEventToCoords === 'function' });

            document.getElementById('hotspotPitch').value = Number(pitchDeg).toFixed(1);
            document.getElementById('hotspotYaw').value = Number(yawDeg).toFixed(1);

            console.log('[HS] handleViewerClick inputs set', { pitch: document.getElementById('hotspotPitch').value, yaw: document.getElementById('hotspotYaw').value });


            // Atualizar habilita√ß√£o do bot√£o salvar com base nos campos
            updateSaveButtonState();

            // Desativar modo adicionar, mas manter as coordenadas
            toggleAddMode(true);

            showAlert('Coordenadas definidas! Preencha as informa√ß√µes do hotspot.', 'success');
        }

        // Handle movimento do mouse
        function handleViewerMouseMove(event) {
            if (!isDragging || !draggedHotspot) return;

            // Obter coordenadas atuais
            const pitch = viewer.getPitch();
            const yaw = viewer.getYaw();

            // Converter radianos para graus
            const pitchDeg = pitch * 180 / Math.PI;
            const yawDeg = ((yaw * 180 / Math.PI) + 360) % 360;

            // Atualizar posi√ß√£o do hotspot temporariamente
            updateHotspotPosition(draggedHotspot.id, pitchDeg, yawDeg);
        }

        // Iniciar drag de hotspot
        function startDragHotspot(hotspot, event) {
            isDragging = true;
            draggedHotspot = hotspot;
            dragStartCoords = { pitch: hotspot.pitch, yaw: hotspot.yaw };

            // Adicionar event listeners para finalizar drag
            document.addEventListener('mouseup', finishDragHotspot);
            document.addEventListener('keydown', cancelDragHotspot);

            showAlert(`Arrastando hotspot "${hotspot.title}". Clique para posicionar ou ESC para cancelar.`, 'info');
        }

        // Finalizar drag de hotspot
        function finishDragHotspot(event) {
            if (!isDragging || !draggedHotspot) return;

            // Obter coordenadas finais
            const pitch = viewer.getPitch();
            const yaw = viewer.getYaw();

            // Converter radianos para graus
            const pitchDeg = pitch * 180 / Math.PI;
            const yawDeg = ((yaw * 180 / Math.PI) + 360) % 360;

            // Atualizar hotspot no banco de dados
            updateHotspotInDatabase(draggedHotspot.id, pitchDeg, yawDeg);

            // Limpar estado de drag
            cleanupDrag();
        }

        // Cancelar drag com ESC
        function cancelDragHotspot(event) {
            if (event.key === 'Escape' && isDragging && draggedHotspot) {
                // Restaurar posi√ß√£o original
                updateHotspotPosition(draggedHotspot.id, dragStartCoords.pitch, dragStartCoords.yaw);
                cleanupDrag();
                showAlert('Reposicionamento cancelado.', 'info');
            }
        }

        // Limpar estado de drag
        function cleanupDrag() {
            isDragging = false;
            draggedHotspot = null;
            dragStartCoords = null;

            document.removeEventListener('mouseup', finishDragHotspot);
            document.removeEventListener('keydown', cancelDragHotspot);
        }

        // Atualizar posi√ß√£o do hotspot visualmente
        function updateHotspotPosition(hotspotId, pitch, yaw) {
            if (!viewer) return;

            // Remover hotspot atual
            viewer.removeHotSpot(hotspotId);

            // Encontrar hotspot nos dados
            const hotspot = hotspots.find(h => h.id === hotspotId);
            if (!hotspot) return;

            // Criar hotspot atualizado
            const hotspotConfig = {
                id: hotspot.id,
                pitch: pitch,
                yaw: yaw,
                type: 'info',
                text: hotspot.title,
                cssClass: `hotspot-${hotspot.type}`,
                clickHandlerFunc: () => selectHotspot(hotspot.id),
                createTooltipFunc: (hotSpotDiv, args) => {
                    hotSpotDiv.style.backgroundColor = hotspot.color || '#007bff';
                    return hotspot.title;
                }
            };

            viewer.addHotSpot(hotspotConfig);
        }

        // Atualizar hotspot no banco de dados
        async function updateHotspotInDatabase(hotspotId, pitch, yaw) {
            try {
                const result = await hotspotManager.updateHotspot(hotspotId, {
                    pitch: pitch,
                    yaw: yaw
                });

                if (result.success) {
                    // Atualizar dados locais
                    const hotspot = hotspots.find(h => h.id === hotspotId);
                    if (hotspot) {
                        hotspot.pitch = pitch;
                        hotspot.yaw = yaw;
                    }

                    updateHotspotsList();
                    showAlert(`Hotspot "${hotspot.title}" reposicionado com sucesso!`, 'success');
                } else {
                    showAlert(`Erro ao reposicionar hotspot: ${result.error}`, 'error');
                    // Restaurar posi√ß√£o original em caso de erro
                    if (dragStartCoords) {
                        updateHotspotPosition(hotspotId, dragStartCoords.pitch, dragStartCoords.yaw);
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar hotspot:', error);
                showAlert('Erro inesperado ao reposicionar hotspot.', 'error');
            }
        }

        // Salvar hotspot
        window.saveHotspot = async function() {
            const title = document.getElementById('hotspotTitle').value;
            const description = document.getElementById('hotspotDescription').value;
            const pitch = parseFloat(document.getElementById('hotspotPitch').value);
            const yaw = parseFloat(document.getElementById('hotspotYaw').value);
            const color = document.getElementById('hotspotColor').value;
            const targetSceneId = document.getElementById('targetScene').value;

            if (!title) {
                showAlert('O t√≠tulo do hotspot √© obrigat√≥rio.', 'error');
                return;
            }

            if (isNaN(pitch) || isNaN(yaw)) {
                showAlert('Coordenadas inv√°lidas. Clique na imagem para posicionar.', 'error');
                return;
            }

            const hotspotData = {
                scene_id: currentScene.id,
                type: selectedHotspotType,
                pitch: pitch,
                yaw: yaw,
                title: title,
                description: description,
                color: color,
                target_scene_id: selectedHotspotType === 'navigation' ? targetSceneId : null
            };

            try {
                let result;

                if (editingHotspot) {
                    result = await hotspotManager.updateHotspot(editingHotspot.id, hotspotData);
                } else {
                    result = await hotspotManager.createHotspot(hotspotData);
                }

                if (result.success) {
                    showAlert(
                        editingHotspot ? 'Hotspot atualizado com sucesso!' : 'Hotspot criado com sucesso!',
                        'success'
                    );

                    clearHotspotForm();
                    await loadHotspots();
                } else {
                    showAlert(result.error || 'Erro ao salvar hotspot.', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar hotspot:', error);
                showAlert('Erro inesperado ao salvar hotspot.', 'error');
            }
        };

        // Limpar formul√°rio
        function clearHotspotForm() {
            document.getElementById('hotspotTitle').value = '';
            document.getElementById('hotspotDescription').value = '';
            document.getElementById('hotspotPitch').value = '';
            document.getElementById('hotspotYaw').value = '';
            document.getElementById('hotspotColor').value = '#007bff';
            document.getElementById('targetScene').value = '';
            document.getElementById('saveHotspotBtn').disabled = true;
            document.getElementById('cancelHotspotBtn').style.display = 'none';
            editingHotspot = null;
        }

        // Editar hotspot
        window.editHotspot = function(hotspotId) {
            const hotspot = hotspots.find(h => h.id === hotspotId);
            if (!hotspot) return;

            editingHotspot = hotspot;

            // Preencher formul√°rio
            document.getElementById('hotspotTitle').value = hotspot.title;
            document.getElementById('hotspotDescription').value = hotspot.description || '';
            document.getElementById('hotspotPitch').value = hotspot.pitch;
            document.getElementById('hotspotYaw').value = hotspot.yaw;
            document.getElementById('hotspotColor').value = hotspot.color || '#007bff';
            document.getElementById('targetScene').value = hotspot.target_scene_id || '';

            // Selecionar tipo
            document.querySelectorAll('.hotspot-type').forEach(t => t.classList.remove('selected'));
            document.querySelector(`[data-type="${hotspot.type}"]`).classList.add('selected');
            selectedHotspotType = hotspot.type;

            // Mostrar campo de cena de destino se necess√°rio
            const targetSceneGroup = document.getElementById('targetSceneGroup');
            targetSceneGroup.style.display = hotspot.type === 'navigation' ? 'block' : 'none';

            // Habilitar bot√µes
            updateSaveButtonState();
            document.getElementById('cancelHotspotBtn').style.display = 'block';

            showAlert('Editando hotspot. Modifique os campos e clique em Salvar.', 'info');
        };

        // Cancelar edi√ß√£o
        window.cancelHotspot = function() {
            clearHotspotForm();
            showAlert('Edi√ß√£o cancelada.', 'info');
        };

        // Deletar hotspot
        window.deleteHotspot = async function(hotspotId) {
            if (!confirm('Tem certeza que deseja excluir este hotspot?')) {
                return;
            }

            try {
                const result = await hotspotManager.deleteHotspot(hotspotId);

                if (result.success) {
                    showAlert('Hotspot exclu√≠do com sucesso!', 'success');
                    await loadHotspots();
                } else {
                    showAlert(result.error || 'Erro ao excluir hotspot.', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir hotspot:', error);
                showAlert('Erro inesperado ao excluir hotspot.', 'error');
            }
        };

        // Selecionar hotspot
        function selectHotspot(hotspotId) {
            // Destacar na lista
            document.querySelectorAll('.hotspot-item').forEach(item => {
                item.classList.remove('selected');
            });

            const item = document.querySelector(`[data-hotspot-id="${hotspotId}"]`);
            if (item) {
                item.classList.add('selected');
            }
        }

        // Voltar
        window.goBack = function() {
            window.location.href = `/admin/scene-manager.html?propertyId=${propertyId}`;
        };

        // Salvar e preview
        window.saveAndPreview = function() {
            window.open(`/client/tour.html?id=${propertyId}`, '_blank');
        };

        // Salvar e sair
        window.saveAndExit = function() {
            window.location.href = `/admin/property-editor.html?id=${propertyId}`;
        };

        // Fun√ß√£o para mostrar alerta
        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';

            // Auto-hide ap√≥s 5 segundos
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
